Test suite for `holo-build`
===========================

The `holo-build` binary is tested using test package definitions, which are
built into packages with all available generators. The resulting packages are
then compared to the expectations recorded for each test case.

`holo-build` runs in `--reproducible` mode during testing, so technically the
test should pass if the same exact archive is generated (down to the last byte)
that was generated when the test first passed. However, when the test fails,
comparing differences between binary package files is unnecessarily tedious,
so we use the helper program [dump-package.go](./dump-package.go) to convert
packages into a readable form, that looks something like this:

    $ tar cJf foo.tar.xz foo/
    $ ./build/dump-package < foo.tar.xz
    XZ-compressed data
        POSIX tar archive
            >> foo/ is directory (mode: 0755, owner: 1000, group: 1000)
            >> foo/bar is regular file (mode: 0600, owner: 1000, group: 1000), content: data as shown below
                Hello World!
            >> foo/baz is symlink to bar

Each test case is in one of the subdirectories, with the directory names sorted
by ascending test complexity (so that when something breaks, it breaks in the
easy tests first and you'll have an easier time figuring out the bug). Each
test case looks like this:

    test/holo-build/                     <-- this directory
        01-minimal/                      <-- the directory for the test setup
            input.toml                   <-- package definition file
            suggested-filenames          <-- output of `holo-build --suggest-filename` for each generator
            $g-output                    <-- text dump of result package for generator $g (generated by test run)
            $g-stderr-output             <-- stderr output of `holo-build` for generator $g
            expected-suggested-filenames <-- what we expect to be in suggested-filenames
            expected-$g-output           <-- what we expect to be in $g-output
            expected-$g-stderr-output    <-- what we expect to be in $g-error-output (usually empty)

The generator name `$g` is the one in the CLI option that selects this
generator. `holo-build` is called as

    holo-build --$g --reproducible --stdout < input.toml 2> $g-stderr-output | dump-package > $g-output

Running the tests
-----------------

To run all the tests, use the make targets `test` or `check` in the top-level
directory or say

    bash test/holo-build/run_tests.sh

To run just some tests, give the test names (the directory names below the
`test/holo-build` directory) as arguments:

    bash test/holo-build/run_tests.sh 01-minimal

The test will usually output just a progress display (one line per test case).
If a test fails, the failing parts will be printed on the command line. To flag
test failure when run in Continuous Integration setups, `run_tests.sh` will
exit with non-zero status when one or more test cases fail.

Writing new testcases
---------------------

To build a new testcase, first create the test directory and its `input.toml`.
THis file should also contain an explanation of what the testcase checks.

Now run your testcase. It will obviously fail since all the files that it
compares its build results to are missing. But we can use these build results
as basis for the missing files. Copy

    $g-output        -> expected-$g-output
    $g-stderr-output -> expected-$g-stderr-output

for each generator `$g`. And the most important step of them all, before
checking them into source control, verify carefully that these files really
contain the *expected* results of the testcase run. When that is done, your
testcase should now pass.  Or not, if the code needs fixing. ;)
